<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Radar Voiture</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html, body { margin:0; padding:0; height:100%; background:#000; }
#map { width:100%; height:100%; }

.car {
  width:40px;
  height:40px;
  background:#e81922;
  clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
}

#alert {
  position:absolute;
  top:20%;
  left:50%;
  transform:translateX(-50%);
  background:#e81922;
  color:white;
  font-size:26px;
  font-weight:bold;
  padding:20px 30px;
  border-radius:15px;
  display:none;
  z-index:1000;
}

.controls {
  position:absolute;
  top:20px;
  right:20px;
  z-index:1000;
  display:flex;
  flex-direction:column;
  gap:10px;
}

.controls button {
  background:#111;
  color:white;
  border:1px solid #444;
  padding:10px;
  border-radius:10px;
  font-size:14px;
}
</style>
</head>

<body>

<div id="map"></div>
<div id="alert">ðŸš¨ RADAR ðŸš¨</div>

<div class="controls">
  <button onclick="toggleFollow()">AUTO / LIBRE</button>
  <button onclick="recenter()">RECENTRER</button>
</div>

<script>
let map, carMarker;
let followCar = true;
let lastRadarFetch = null;
let radarLayer = L.layerGroup();
const alertBox = document.getElementById('alert');
const DETECT_DISTANCE = 500; // mÃ¨tres
let audioCtx;

// INIT MAP
map = L.map('map', { zoomControl:false }).setView([48.8566,2.3522], 15);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
radarLayer.addTo(map);

// AUDIO
function beep(){
  if(!audioCtx) audioCtx = new AudioContext();
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.frequency.value = 900;
  gain.gain.value = 0.2;
  osc.start();
  osc.stop(audioCtx.currentTime + 0.15);
}

// RADARS OSM
async function loadRadars(latlng){
  if(lastRadarFetch && latlng.distanceTo(lastRadarFetch) < 300) return;
  lastRadarFetch = latlng;

  radarLayer.clearLayers();

  const b = map.getBounds().pad(0.5);
  const query = `
  [out:json];
  node["highway"="speed_camera"](${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()});
  out;
  `;
  const url = "https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(query);

  const res = await fetch(url);
  const data = await res.json();

  data.elements.forEach(r=>{
    const pos = L.latLng(r.lat, r.lon);
    L.circleMarker(pos,{
      radius:6,
      color:'#fff',
      fillColor:'#e81922',
      fillOpacity:1
    }).addTo(radarLayer);
  });
}

// CHECK RADAR DISTANCE
function checkRadars(pos){
  let detected = false;
  radarLayer.eachLayer(l=>{
    const d = pos.distanceTo(l.getLatLng());
    if(d < DETECT_DISTANCE){
      detected = true;
    }
  });

  if(detected){
    alertBox.style.display = 'block';
    beep();
  } else {
    alertBox.style.display = 'none';
  }
}

// GPS SUIVI VOITURE
navigator.geolocation.watchPosition(p=>{
  const latlng = L.latLng(p.coords.latitude, p.coords.longitude);

  if(!carMarker){
    carMarker = L.marker(latlng,{
      icon:L.divIcon({
        className:'',
        html:'<div class="car"></div>',
        iconSize:[40,40],
        iconAnchor:[20,20]
      })
    }).addTo(map);
  } else {
    carMarker.setLatLng(latlng);
  }

  if(followCar) map.setView(latlng, map.getZoom(), {animate:false});

  loadRadars(latlng);
  checkRadars(latlng);

},err=>console.error(err),{
  enableHighAccuracy:true,
  maximumAge:500,
  timeout:5000
});

// CONTROLS
function toggleFollow(){ followCar = !followCar; }
function recenter(){
  if(carMarker){
    followCar = true;
    map.setView(carMarker.getLatLng(), map.getZoom(), {animate:true});
  }
}
</script>
</body>
</html>
