<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeslaPilot - D√©tecteur Radars (D√©mo Priv√©e)</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            text-align: center; 
            padding: 20px; 
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            margin: 0;
        }
        h1 { margin-bottom: 10px; font-size: 24px; }
        #status { 
            font-size: 18px; 
            margin: 20px; 
            padding: 15px;
            background: rgba(0,0,0,0.4);
            border-radius: 10px;
        }
        #nearest { 
            background: #ff9800; 
            color: black; 
            padding: 12px; 
            border-radius: 8px; 
            margin: 15px; 
            font-weight: bold;
            display: none;
        }
        #map { height: 450px; width: 100%; margin-top: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        button { 
            padding: 12px 24px; 
            font-size: 18px; 
            margin: 10px; 
            border: none; 
            border-radius: 8px; 
            background: #f44336; 
            color: white; 
            cursor: pointer; 
        }
        button:hover { background: #d32f2f; }
        .warning { font-size: 14px; color: #ffeb3b; margin: 20px; }
    </style>
</head>
<body>
    <h1>üö® TeslaPilot - D√©tecteur Radars (D√©mo Priv√©e)</h1>
    <p class="warning">‚ö†Ô∏è Usage d√©monstration seulement ‚Äì Positions exactes (interdit sur route ouverte en France)</p>
    <p id="status">Chargement des radars...</p>
    <div id="nearest"></div>
    <button onclick="startWatching()">‚ñ∂Ô∏è D√©marrer GPS</button>
    <button onclick="stopWatching()">‚èπÔ∏è Arr√™ter</button>
    <div id="map"></div>

    <script>
        let radars = {};
        let watchId = null;
        let lastAlerted = new Set();
        let map, userMarker;

        // Distance Haversine en km
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a = Math.sin(dLat / 2) ** 2 +
                      Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                      Math.sin(dLon / 2) ** 2;
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }
        function deg2rad(deg) { return deg * (Math.PI / 180); }

        // Normalise les champs (compatible anciens/nouveaux formats)
        function getRadar(radarObj) {
            return {
                type: radarObj.type || radarObj["Type de radar"] || 'Inconnu',
                vitesse: radarObj.vitesse || radarObj.VMA || '50',
                direction: radarObj.direction || radarObj["Direction"] || 'Double sens',
                lat: parseFloat(radarObj.lat || radarObj.Latitude),
                lon: parseFloat(radarObj.lon || radarObj.Longitude)
            };
        }

        // Chargement radars
        fetch('radars.json')
            .then(res => res.json())
            .then(data => {
                radars = data;
                const count = Object.keys(radars).length;
                document.getElementById('status').innerHTML = `‚úÖ ${count} radars charg√©s !<br>Pr√™t pour la d√©mo.`;
                initMap();
                // Ajoute tous les radars sur la carte (cercles rouges)
                Object.entries(radars).forEach(([id, r]) => {
                    const rad = getRadar(r);
                    if (rad.lat && rad.lon) {
                        L.circleMarker([rad.lat, rad.lon], {radius: 8, color: '#f00', fillOpacity: 0.8})
                            .addTo(map)
                            .bindPopup(`Radar ${id}<br>${rad.type}<br>${rad.direction}<br>Limite ${rad.vitesse} km/h`);
                    }
                });
            })
            .catch(err => {
                console.error(err);
                document.getElementById('status').textContent = '‚ùå Erreur radars.json ‚Äì V√©rifie le format';
            });

        // Carte Leaflet
        function initMap() {
            map = L.map('map').setView([46.2276, 2.2137], 6); // Centre France
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap'
            }).addTo(map);
        }

        function startWatching() {
            if (!navigator.geolocation) return alert('GPS non support√©');
            watchId = navigator.geolocation.watchPosition(pos => {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                const speed = pos.coords.speed ? (pos.coords.speed * 3.6).toFixed(0) : '?';
                document.getElementById('status').innerHTML = 
                    `üìç ${lat.toFixed(5)}, ${lon.toFixed(5)}<br>üöó Vitesse : ${speed} km/h`;

                // Mise √† jour position sur carte
                if (userMarker) userMarker.setLatLng([lat, lon]);
                else userMarker = L.marker([lat, lon], {icon: L.icon({iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png'})})
                    .addTo(map).bindPopup('üöô Ta position');
                map.setView([lat, lon], 13);

                // Recherche radars proches
                let closestDist = Infinity;
                let closestId = null;

                Object.entries(radars).forEach(([id, radarObj]) => {
                    const r = getRadar(radarObj);
                    if (!r.lat || !r.lon) return;
                    const dist = getDistance(lat, lon, r.lat, r.lon);

                    if (dist < closestDist) {
                        closestDist = dist;
                        closestId = id;
                        document.getElementById('nearest').style.display = 'block';
                        document.getElementById('nearest').innerHTML = 
                            `üî¥ Plus proche : Radar ${id}<br>${r.type} ‚Äì ${r.direction}<br>Distance : ${dist.toFixed(2)} km (limite ${r.vitesse} km/h)`;
                    }

                    // ALERTE √Ä 500 M√àTRES
                    if (dist <= 0.5 && !lastAlerted.has(id)) {
                        const msg = `üö® RADAR IMMINENT ! ${r.type} (${r.direction}) √† ${(dist*1000).toFixed(0)} m√®tres (limite ${r.vitesse} km/h) ! Ralentis !`;
                        alert(msg);
                        speak(msg);
                        lastAlerted.add(id);
                        setTimeout(() => lastAlerted.delete(id), 120000); // 2 min cooldown
                    }
                });

            }, err => {
                document.getElementById('status').textContent = '‚ùå Erreur GPS : ' + err.message;
            }, { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 });
        }

        function stopWatching() {
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
                document.getElementById('status').textContent = 'Surveillance arr√™t√©e.';
            }
        }

        function speak(text) {
            if ('speechSynthesis' in window) {
                const utt = new SpeechSynthesisUtterance(text.replace(/üö®|üî¥/g, ''));
                utt.lang = 'fr-FR';
                utt.rate = 1.1;
                utt.volume = 1;
                speechSynthesis.speak(utt);
            }
        }

        // D√©marrage auto sur mobile
        if (/Mobi|Android|iPhone/i.test(navigator.userAgent)) {
            setTimeout(() => {
                if (confirm('Lancer la d√©mo GPS ?')) startWatching();
            }, 1500);
        }
    </script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</body>
</html>
