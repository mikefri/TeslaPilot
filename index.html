<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TeslaPilot V1</title>

<link rel="stylesheet" href="leaflet/leaflet.css">
<link rel="stylesheet" href="style.css">
</head>
<body>

<div id="radar-modal">
  <div style="font-size: 18px; color:#E81922; font-weight: 900;">‚ö†Ô∏è RADAR ‚ö†Ô∏è</div>
  <div class="speed-circle" id="modal-speed">--</div>
  <div id="dist-text">APPROCHE...</div>
  <div class="proxi-container"><div id="proxi-bar"></div></div>
</div>

<div class="side-controls">
  <button id="orientBtn" class="side-btn">NORD</button>
  <button id="btnRecenter" class="side-btn">üß≠</button>
  <button class="side-btn" id="btnTest">TEST</button>
</div>

<div id="map-container">
  <div id="map"></div>
</div>

<script src="leaflet/leaflet.js"></script>
<script src="leaflet-geometryutil/leaflet.geometryutil.js"></script>

<script>
// CONFIG
let config = { distance: 500, volume: 0.15, soundEnabled: true };

// INIT MAP
let map = L.map('map', { zoomControl:false }).setView([48.8566, 2.3522], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
let radarLayer = L.layerGroup().addTo(map);

// CAR
let carMarker = null;
let currentBearing = 0;
let myPos = null;

// AUDIO
let audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function beep() {
  if(!config.soundEnabled) return;
  let osc = audioCtx.createOscillator();
  let gain = audioCtx.createGain();
  osc.connect(gain); gain.connect(audioCtx.destination);
  osc.frequency.value = 880;
  gain.gain.setValueAtTime(config.volume, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime+0.15);
  osc.start(); osc.stop(audioCtx.currentTime+0.15);
}

// GPS / SIMULATION
function moveCar(latlng) {
  if(myPos) currentBearing = L.GeometryUtil.getBearing(myPos, latlng);
  myPos = latlng;

  if(!carMarker){
    carMarker = L.marker(myPos, { 
      icon: L.divIcon({ html: `<div style="width:30px;height:30px;background:red;border-radius:50%;"></div>`, className:'', iconSize:[30,30], iconAnchor:[15,15] })
    }).addTo(map);
  } else carMarker.setLatLng(myPos);

  map.setView(myPos);

  fetchRadars();
}

// RADARS (simulation ici pour test)
function fetchRadars(){
  radarLayer.clearLayers();
  if(!myPos) return;

  // exemple 3 radars fixes
  let radars = [
    L.latLng(myPos.lat+0.001, myPos.lng+0.001),
    L.latLng(myPos.lat-0.0015, myPos.lng+0.002),
    L.latLng(myPos.lat+0.002, myPos.lng-0.002)
  ];

  radars.forEach(r => {
    let dist = map.distance(myPos, r);
    L.marker(r).addTo(radarLayer);
    if(dist<config.distance) {
      document.getElementById('modal-speed').innerText = "110";
      document.getElementById('radar-modal').style.display = "block";
      beep();
    }
  });
}

// BOUTONS
document.getElementById('btnRecenter').onclick = ()=>{ if(myPos) map.setView(myPos); };
document.getElementById('orientBtn').onclick = ()=>{ alert("Orientation toggl√©e !"); };
document.getElementById('btnTest').onclick = ()=>{ 
  alert("Test radar d√©clench√© !"); 
  moveCar(L.latLng(myPos.lat+0.0005, myPos.lng+0.0005));
};

// GPS / simulation initiale
if(navigator.geolocation){
  navigator.geolocation.watchPosition(p => moveCar(L.latLng(p.coords.latitude, p.coords.longitude)));
} else {
  // simulation si pas de GPS
  myPos = L.latLng(48.8566,2.3522);
  moveCar(myPos);
}
</script>

</body>
</html>
