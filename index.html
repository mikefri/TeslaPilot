<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TeslaRadar</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-geometryutil@0.9.3/src/leaflet.geometryutil.min.js"></script>

<style>
  html, body { height: 100%; margin:0; }
  #map { width:100%; height:100%; }
  .status-panel { position:absolute; bottom:10px; right:10px; background:rgba(0,0,0,0.6); color:white; padding:8px 12px; border-radius:10px; font-family:sans-serif; }
  .side-btn { position:absolute; top:10px; right:10px; z-index:1000; background:#E81922; color:white; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; }
</style>
</head>
<body>

<div id="map"></div>
<div class="status-panel" id="clock">00:00:00</div>
<button class="side-btn" id="recenterBtn">Recentrer</button>

<script>
let map = L.map('map', { zoomControl:false }).setView([48.8566,2.3522], 13); // Paris par défaut

// Carte OSM
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap',
    maxZoom: 19
}).addTo(map);

// Marker voiture
let carMarker = null;
let myPos = null;
let currentBearing = 0;

// Radar cache local
let radarCache = [];

// Audio beep
let audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function beep(){
    let osc = audioCtx.createOscillator();
    let gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.frequency.value = 880;
    gain.gain.setValueAtTime(0.15, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime+0.2);
    osc.start(); osc.stop(audioCtx.currentTime+0.2);
}

// Clock
setInterval(()=>{document.getElementById('clock').innerText=new Date().toLocaleTimeString('fr-FR')},1000);

// Recentrage
document.getElementById('recenterBtn').onclick = () => {
    if(myPos) map.setView(myPos, map.getZoom());
};

// Simulation / GPS réel
map.locate({watch:true, enableHighAccuracy:true});
map.on('locationfound', e=>{
    myPos = e.latlng;
    // Calcul orientation
    if(carMarker){
        currentBearing = L.GeometryUtil.getBearing(carMarker.getLatLng(), myPos);
        carMarker.setLatLng(myPos);
        carMarker.setRotationAngle(currentBearing);
    } else {
        carMarker = L.marker(myPos, {rotationAngle:0, rotationOrigin:'center', icon: L.divIcon({className:'', html:'<div style="width:30px;height:30px;background:red;clip-path:polygon(50% 0%,0% 100%,100% 100%)"></div>', iconSize:[30,30]}) }).addTo(map);
    }
    map.setView(myPos, map.getZoom());
    checkRadars();
});

// Charger radars depuis Overpass ou cache
async function loadRadars(){
    if(radarCache.length) return radarCache;
    const bounds = map.getBounds();
    const url = 'https://overpass-api.de/api/interpreter?data='+
        encodeURIComponent(`[out:json];node["highway"="speed_camera"](${bounds.getSouth()},${bounds.getWest()},${bounds.getNorth()},${bounds.getEast()});out body;`);
    try{
        let res = await fetch(url);
        let data = await res.json();
        radarCache = data.elements.map(r=>({lat:r.lat, lon:r.lon, maxspeed:r.tags.maxspeed||"??"}));
        return radarCache;
    }catch(e){console.error(e); return [];}
}

// Vérifie les radars proches et devant
async function checkRadars(){
    if(!myPos) return;
    const radars = await loadRadars();
    radars.forEach(r=>{
        const radarPos = L.latLng(r.lat,r.lon);
        const dist = map.distance(myPos, radarPos);
        const bearing = L.GeometryUtil.getBearing(myPos, radarPos);
        const diff = Math.abs(currentBearing - bearing)>180?360-Math.abs(currentBearing-bearing):Math.abs(currentBearing-bearing);
        if(dist<500 && diff<45){ // 500m et devant
            beep();
            if(navigator.vibrate) navigator.vibrate(300);
            L.circle(radarPos,{radius:20,color:'red',fillOpacity:0.3}).addTo(map);
        }
    });
}

// Mise à jour radar si on bouge
map.on('moveend', ()=>{radarCache=[]; checkRadars();});
</script>

</body>
</html>
