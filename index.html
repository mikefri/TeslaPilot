<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>TeslaPilot â€“ GPS</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-geometryutil"></script>

<style>
html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    background: #000;
    font-family: Arial, sans-serif;
}

#map {
    width: 100%;
    height: 100%;
}

/* Boutons */
.control-btn {
    position: absolute;
    right: 15px;
    z-index: 999;
    padding: 12px 16px;
    border-radius: 20px;
    border: none;
    background: #111;
    color: white;
    font-size: 14px;
    box-shadow: 0 6px 20px rgba(0,0,0,.4);
}

#orientBtn {
    top: 15px;
}

#recenterBtn {
    bottom: 90px;
    display: none;
}
</style>
</head>

<body>

<div id="map"></div>

<button id="orientBtn" class="control-btn" onclick="toggleOrientation()">
    <span id="orientText">NORD</span>
</button>

<button id="recenterBtn" class="control-btn" onclick="recenterMap()">
    ðŸŽ¯ Recentrer
</button>

<script>
/* =========================
   VARIABLES GLOBALES
========================= */
let map;
let carMarker = null;
let myPos = null;
let currentBearing = 0;

let mapMode = "north";   // north | direction
let followCar = true;
let userInteracting = false;

/* =========================
   INITIALISATION MAP
========================= */
map = L.map('map', {
    zoomControl: false
}).setView([48.8566, 2.3522], 18);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 20
}).addTo(map);

/* =========================
   MODE EXPLORATION AUTO
========================= */
map.on('dragstart zoomstart', () => {
    followCar = false;
    userInteracting = true;
    showRecenterButton();
});

/* =========================
   SVG VOITURE
========================= */
function getCarSvg(angle, mode) {
    const rot = (mode === "north") ? angle : 0;

    return `
    <svg width="50" height="50" viewBox="0 0 100 100"
         style="transform: rotate(${rot}deg); transition: transform .25s linear;">
        <path d="M50 10 L85 85 L50 70 L15 85 Z"
              fill="#E81922"
              stroke="white"
              stroke-width="5"
              stroke-linejoin="round"/>
    </svg>`;
}

/* =========================
   MISE Ã€ JOUR VOITURE
========================= */
function moveCar(latlng) {

    if (myPos && map.distance(myPos, latlng) > 5) {
        currentBearing = L.GeometryUtil.getBearing(myPos, latlng);
    }
    myPos = latlng;

    if (!carMarker) {
        carMarker = L.marker(myPos, {
            icon: L.divIcon({
                html: getCarSvg(0, mapMode),
                className: '',
                iconSize: [50, 50],
                iconAnchor: [25, 25]
            })
        }).addTo(map);
    } else {
        carMarker.setLatLng(myPos);
        carMarker.setIcon(L.divIcon({
            html: getCarSvg(currentBearing, mapMode),
            className: '',
            iconSize: [50, 50],
            iconAnchor: [25, 25]
        }));
    }

    if (followCar && !userInteracting) {
        map.setView(myPos, map.getZoom(), { animate: true });
    }
}

/* =========================
   BOUTON ORIENTATION
========================= */
function toggleOrientation() {
    mapMode = (mapMode === "north") ? "direction" : "north";
    document.getElementById('orientText').innerText =
        (mapMode === "north") ? "NORD" : "SENS";

    if (carMarker) {
        carMarker.setIcon(L.divIcon({
            html: getCarSvg(currentBearing, mapMode),
            className: '',
            iconSize: [50, 50],
            iconAnchor: [25, 25]
        }));
    }
}

/* =========================
   BOUTON RECENTRER
========================= */
function showRecenterButton() {
    document.getElementById('recenterBtn').style.display = 'block';
}

function hideRecenterButton() {
    document.getElementById('recenterBtn').style.display = 'none';
}

function recenterMap() {
    if (!myPos) return;

    followCar = true;
    userInteracting = false;

    map.setView(myPos, map.getZoom(), {
        animate: true,
        duration: 0.5
    });

    hideRecenterButton();
}

/* =========================
   SIMULATION GPS (TEST)
========================= */
let demoLat = 48.8566;
let demoLng = 2.3522;

setInterval(() => {
    demoLng += 0.00002;
    moveCar([demoLat, demoLng]);
}, 1200);
</script>

</body>
</html>
