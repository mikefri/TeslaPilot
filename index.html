<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TeslaPilot â€“ Radar</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html,body { margin:0; height:100%; background:#000; color:white; font-family:sans-serif }
#map { width:100%; height:100% }

.side {
  position:absolute; right:15px; top:15px;
  display:flex; flex-direction:column; gap:10px; z-index:1000;
}
.btn {
  width:52px; height:52px;
  border-radius:50%;
  background:rgba(0,0,0,0.85);
  border:1px solid #444;
  color:white;
  font-weight:bold;
  cursor:pointer;
}

#toast {
  position:fixed;
  bottom:90px;
  left:50%;
  transform:translateX(-50%);
  background:rgba(0,0,0,0.85);
  padding:12px 24px;
  border-radius:30px;
  opacity:0;
  transition:.3s;
  z-index:2000;
}
#toast.show { opacity:1 }

#radar {
  position:absolute;
  top:40%;
  left:50%;
  transform:translate(-50%,-50%);
  background:black;
  border:4px solid #E81922;
  padding:20px;
  border-radius:30px;
  display:none;
  z-index:3000;
  text-align:center;
}
</style>
</head>

<body>

<div id="map"></div>

<div class="side">
  <button class="btn" onclick="toggleAuto()">AUTO</button>
  <button class="btn" onclick="recenter()">ðŸŽ¯</button>
  <button class="btn" onclick="initAudio()">ðŸ”Š</button>
</div>

<div id="toast"></div>

<div id="radar">
  <div style="color:#E81922;font-weight:900">RADAR</div>
  <div id="radarDist" style="font-size:32px">---</div>
</div>

<script>
/* ================= BASE ================= */
let map = L.map('map',{ zoomControl:false }).setView([48.8566,2.3522],15);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let autoMode = true;
let userPos = null;
let carMarker = null;
let radarLayer = L.layerGroup().addTo(map);
let audioCtx = null;
let lastAlert = 0;

/* ================= TOAST ================= */
let toastTimer;
function showToast(msg){
  const t=document.getElementById('toast');
  t.innerText=msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>t.classList.remove('show'),1500);
}

/* ================= AUDIO ================= */
function initAudio(){
  audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  showToast("ðŸ”Š Audio activÃ©");
}
function beep(){
  if(!audioCtx) return;
  const o=audioCtx.createOscillator();
  const g=audioCtx.createGain();
  o.connect(g); g.connect(audioCtx.destination);
  o.frequency.value=900;
  g.gain.value=0.15;
  o.start();
  o.stop(audioCtx.currentTime+0.15);
}

/* ================= CAR ================= */
const carIcon = L.divIcon({
  html:`<svg width="40" height="40" viewBox="0 0 100 100">
    <path d="M50 5 L90 90 L50 70 L10 90 Z" fill="#E81922"/>
  </svg>`,
  iconSize:[40,40],
  iconAnchor:[20,20]
});

function updateCar(latlng){
  userPos=latlng;
  if(!carMarker){
    carMarker=L.marker(latlng,{icon:carIcon}).addTo(map);
  } else {
    carMarker.setLatLng(latlng);
  }
  if(autoMode) map.setView(latlng,map.getZoom());
  fetchRadars();
}

/* ================= MODES ================= */
function toggleAuto(){
  autoMode=!autoMode;
  showToast(autoMode?"ðŸ§­ Mode AUTO":"âœ‹ Mode LIBRE");
}
function recenter(){
  if(userPos) {
    map.setView(userPos,map.getZoom(),{animate:true});
    showToast("ðŸŽ¯ RecentrÃ©");
  }
}

/* ================= RADARS ================= */
async function fetchRadars(){
  if(!userPos) return;

  radarLayer.clearLayers();
  const b=map.getBounds().pad(0.4);
  const q=`[out:json];node["highway"="speed_camera"](${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()});out;`;
  const url="https://overpass-api.de/api/interpreter?data="+encodeURIComponent(q);

  try{
    const r=await fetch(url);
    const d=await r.json();
    d.elements.forEach(e=>{
      const pos=L.latLng(e.lat,e.lon);
      const dist=map.distance(userPos,pos);
      L.circleMarker(pos,{radius:6,color:"#E81922"}).addTo(radarLayer);

      if(dist<500 && Date.now()-lastAlert>5000){
        lastAlert=Date.now();
        document.getElementById('radar').style.display="block";
        document.getElementById('radarDist').innerText=Math.round(dist)+" m";
        beep();
        setTimeout(()=>document.getElementById('radar').style.display="none",3000);
      }
    });
  }catch(e){console.log(e);}
}

/* ================= GPS ================= */
map.locate({watch:true,enableHighAccuracy:true});
map.on('locationfound',e=>updateCar(e.latlng));
</script>

</body>
</html>
