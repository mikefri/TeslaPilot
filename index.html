<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeslaPilot - D√©tecteur Radars (D√©mo Priv√©e)</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            text-align: center; 
            padding: 15px; 
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            color: white;
            margin: 0; transition: all 0.5s;
        }
        body.light { background: linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%); color: #111; }
        h1 { margin: 10px 0; font-size: 26px; }
        #status { 
            font-size: 17px; margin: 15px; padding: 12px;
            background: rgba(0,0,0,0.5); border-radius: 10px; 
        }
        body.light #status { background: rgba(255,255,255,0.6); color: #000; }
        #nearest { 
            background: #ff5722; color: white; padding: 12px; 
            border-radius: 10px; margin: 12px; font-weight: bold; display: none;
        }
        #map { height: 380px; width: 100%; margin: 15px 0; border-radius: 12px; box-shadow: 0 6px 15px rgba(0,0,0,0.6); }
        button { 
            padding: 10px 20px; font-size: 16px; margin: 6px; 
            border: none; border-radius: 8px; cursor: pointer; color: white;
        }
        #start { background: #4caf50; } #stop { background: #f44336; } #toggleTheme { background: #673ab7; }
        #testMode { background: #2196f3; }
        .warning { font-size: 13px; color: #ffeb3b; margin: 10px; }
        #history { margin: 15px; padding: 10px; background: rgba(0,0,0,0.4); border-radius: 10px; font-size: 14px; }
        .toast { 
            position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
            background: #d32f2f; color: white; padding: 14px 24px; border-radius: 12px;
            z-index: 9999; font-size: 18px; box-shadow: 0 6px 20px rgba(0,0,0,0.7);
            max-width: 90%; text-align: center; opacity: 0; transition: opacity 0.4s;
        }
        .toast.show { opacity: 1; }
    </style>
</head>
<body class="dark">
    <h1>üö® TeslaPilot - D√©tecteur Radars (D√©mo Priv√©e)</h1>
    <p class="warning">‚ö†Ô∏è D√©mo seulement ‚Äì Pas pour usage r√©el sur route ouverte en France</p>
    <p id="status">Chargement des radars...</p>
    <div id="nearest"></div>
    <button id="start">‚ñ∂Ô∏è D√©marrer GPS</button>
    <button id="stop">‚èπÔ∏è Arr√™ter</button>
    <button id="toggleTheme">üåô / ‚òÄÔ∏è Th√®me</button>
    <button id="testMode">üß™ Mode Test (simu)</button>
    <div id="map"></div>
    <div id="history"><strong>Historique r√©cent :</strong><br>Aucun pour le moment</div>

    <script>
        let radars = {};
        let watchId = null;
        let lastAlerted = new Set();
        let map, userMarker, userCone;
        let lastCalcTime = 0;
        let history = [];
        let isTestMode = false;
        let testInterval = null;
        let theme = localStorage.getItem('theme') || 'dark';
        document.body.className = theme;

        // Helpers
        function showToast(msg, duration = 7000) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 50);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 400);
            }, duration);
        }

        function speak(text, type = 'default') {
            if ('speechSynthesis' in window) {
                const utt = new SpeechSynthesisUtterance(text.replace(/üö®|üî¥/g, ''));
                utt.lang = 'fr-FR';
                utt.rate = 1.15;
                utt.volume = 1;
                if (type.includes('mobile')) { utt.pitch = 1.4; utt.rate = 1.3; }
                if (type.includes('fixe')) { utt.pitch = 0.9; }
                speechSynthesis.speak(utt);
            }
        }

        function getRadar(obj) {
            return {
                type: obj.type || obj["Type de radar"] || 'Inconnu',
                vitesse: obj.vitesse || obj.VMA || '50',
                direction: obj.direction || obj["Direction"] || 'Double sens',
                lat: parseFloat(obj.lat || obj.Latitude),
                lon: parseFloat(obj.lon || obj.Longitude)
            };
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) * Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        function isApproaching(userLat, userLon, radarLat, radarLon, heading) {
            if (typeof heading !== 'number' || isNaN(heading)) return true;
            const bearing = Math.atan2(radarLon - userLon, radarLat - userLat) * 180 / Math.PI;
            const diff = Math.abs((bearing - heading + 540) % 360 - 180);
            return diff < 100;
        }

        function updateHistory(id, type, dist) {
            history.unshift({id, type, dist: dist.toFixed(1), time: new Date().toLocaleTimeString()});
            if (history.length > 5) history.pop();
            document.getElementById('history').innerHTML = '<strong>Historique r√©cent :</strong><br>' + 
                (history.length ? history.map(h => `${h.time} ‚Äì ${h.type} ${h.id} (${h.dist} km)`).join('<br>') : 'Aucun pour le moment');
        }

        // Fonction principale de traitement d'une position (utilis√©e par GPS r√©el ET mode test)
        function processPosition(pos) {
            const { latitude: lat, longitude: lon, speed, heading, accuracy } = pos.coords;
            const spd = speed ? Math.round(speed * 3.6) : '?';
            const accTxt = accuracy ? `¬±${Math.round(accuracy)}m` : '?';

            document.getElementById('status').innerHTML = 
                `üìç ${lat.toFixed(5)}, ${lon.toFixed(5)}<br>üöó ${spd} km/h | Pr√©cision ${accTxt}`;

            // Marker + c√¥ne
            if (!userMarker) {
                userMarker = L.marker([lat, lon], {
                    icon: L.icon({
                        iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
                        iconSize: [38, 38],
                        iconAnchor: [19, 38]
                    })
                }).addTo(map);
            } else {
                userMarker.setLatLng([lat, lon]);
            }

            if (userCone) map.removeLayer(userCone);
            if (heading >= 0 && !isNaN(heading)) {
                userCone = L.circle([lat, lon], {radius: 40, color: '#2196f3', fillOpacity: 0.25, weight: 2}).addTo(map);
            }

            // Forcer recentrage
            map.invalidateSize(); // tr√®s important sur Tesla !
            map.setView([lat, lon], map.getZoom() < 13 ? 15 : map.getZoom(), { animate: true, duration: 0.6 });

            const now = Date.now();
            if (now - lastCalcTime < 800) return;
            lastCalcTime = now;

            let closestDist = Infinity;
            let closest = null;
            let nearbyCount = 0;

            Object.entries(radars).forEach(([id, obj]) => {
                const r = getRadar(obj);
                if (!r.lat || !r.lon) return;
                const dist = getDistance(lat, lon, r.lat, r.lon);

                if (dist < closestDist) {
                    closestDist = dist;
                    closest = {id, ...r};
                }
                if (dist <= 2) nearbyCount++;

                if (dist <= 0.5 && !lastAlerted.has(id) && isApproaching(lat, lon, r.lat, r.lon, heading)) {
                    const msg = `üö® ${r.type.toUpperCase()} ! √Ä ${Math.round(dist*1000)} m ‚Äì Limite ${r.vitesse} km/h`;
                    showToast(msg, 10000);
                    speak(msg, r.type.toLowerCase());
                    lastAlerted.add(id);
                    setTimeout(() => lastAlerted.delete(id), 180000);

                    updateHistory(id, r.type, dist);
                }
            });

            if (closest) {
                document.getElementById('nearest').style.display = 'block';
                let bgColor = '#4caf50';
                if (closestDist < 1) bgColor = (spd !== '?' && spd > closest.vitesse) ? '#d32f2f' : '#ff9800';
                document.getElementById('nearest').style.background = bgColor;
                document.getElementById('nearest').innerHTML = 
                    `Plus proche : ${closest.type} (${closest.direction})<br>Distance : ${closestDist.toFixed(2)} km ‚Äì Limite ${closest.vitesse} km/h<br>Radars dans 2 km : ${nearbyCount}`;
            }
        }

        // Chargement radars
        function loadRadars() {
            fetch('radars.json')
                .then(res => res.json())
                .then(data => {
                    radars = data;
                    document.getElementById('status').innerHTML = `‚úÖ ${Object.keys(radars).length} radars charg√©s`;
                    initMap();
                })
                .catch(() => {
                    document.getElementById('status').textContent = '‚ùå Erreur radars.json ‚Äì V√©rifie le fichier';
                });
        }

        function initMap() {
            map = L.map('map', { zoomAnimation: false, fadeAnimation: false }).setView([46.2276, 2.2137], 6);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap'
            }).addTo(map);

            // Ajout radars
            Object.entries(radars).forEach(([id, obj]) => {
                const r = getRadar(obj);
                if (r.lat && r.lon) {
                    L.marker([r.lat, r.lon], {
                        icon: L.icon({ iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png', iconSize: [32, 32], iconAnchor: [16, 32] })
                    }).addTo(map).bindPopup(`Radar ${id}<br>${r.type}<br>${r.direction}<br>${r.vitesse} km/h`);
                }
            });

            // Forcer recalcul taille apr√®s init
            setTimeout(() => map.invalidateSize(), 500);
        }

        // D√©marrer GPS r√©el
        document.getElementById('start').onclick = () => {
            if (watchId) return;
            if (!navigator.geolocation) {
                showToast('Geolocation non support√©e');
                return;
            }
            watchId = navigator.geolocation.watchPosition(
                pos => processPosition(pos),
                err => {
                    showToast('Erreur GPS : ' + err.message + ' (code ' + err.code + ')');
                    document.getElementById('status').textContent += ' ‚Äì Autorise la localisation !';
                },
                { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
            );
            showToast('Surveillance GPS d√©marr√©e');
        };

        // Arr√™ter
        document.getElementById('stop').onclick = () => {
            if (watchId) navigator.geolocation.clearWatch(watchId);
            watchId = null;
            if (testInterval) clearInterval(testInterval);
            isTestMode = false;
            document.getElementById('status').textContent = 'Surveillance arr√™t√©e.';
            showToast('Surveillance arr√™t√©e');
        };

        // Mode test
        document.getElementById('testMode').onclick = () => {
            isTestMode = !isTestMode;
            if (isTestMode) {
                showToast('Mode Test activ√© ‚Äì simulation d√©placement');
                let simLat = 46.60;
                let simLon = 3.00;
                const stepLat = -0.0008; // ~90 m par tick
                testInterval = setInterval(() => {
                    simLat += stepLat;
                    const fakePos = {
                        coords: {
                            latitude: simLat,
                            longitude: simLon,
                            speed: 25,          // ~90 km/h
                            heading: 180,       // sud
                            accuracy: 10
                        }
                    };
                    processPosition(fakePos);
                }, 1200);
            } else {
                clearInterval(testInterval);
                showToast('Mode Test d√©sactiv√©');
            }
        };

        // Th√®me
        document.getElementById('toggleTheme').onclick = () => {
            theme = theme === 'dark' ? 'light' : 'dark';
            document.body.className = theme;
            localStorage.setItem('theme', theme);
        };

        // D√©marrage
        loadRadars();
    </script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</body>
</html>
