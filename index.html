<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TeslaPilot V2 - Radar & Navigation</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-geometryutil@0.9.3/src/leaflet.geometryutil.min.js"></script>

<style>
  :root { --tesla-red: #E81922; --glass: rgba(0,0,0,0.95); }
  html, body { margin:0; padding:0; height:100%; background:#000; color:white; font-family:sans-serif; overflow:hidden; }
  #map { width:100%; height:100%; }
  .side-controls { position:absolute; top:20px; right:20px; z-index:2000; display:flex; flex-direction:column; gap:10px; }
  .side-btn { width:50px; height:50px; border-radius:50%; background:var(--glass); border:1px solid rgba(255,255,255,0.2); display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:20px; }
  #radar-modal { position:absolute; top:40%; left:50%; transform:translate(-50%,-50%) scale(0.5); width:250px; background:var(--glass); border:4px solid var(--tesla-red); border-radius:25px; padding:20px; text-align:center; opacity:0; visibility:hidden; transition:all 0.3s ease; z-index:9999; }
  #radar-modal.show { transform:translate(-50%,-50%) scale(1.2); opacity:1; visibility:visible; }
  #proxi-bar { width:100%; height:12px; background:linear-gradient(90deg,#ff0000,#ffea00,#00ff00); border-radius:10px; transition:width 0.2s; }
  #clock { position:absolute; bottom:20px; right:20px; font-size:22px; font-weight:bold; z-index:1000; background:rgba(0,0,0,0.6); padding:10px 15px; border-radius:15px; border-right:4px solid var(--tesla-red); }
</style>
</head>
<body>

<div id="map"></div>

<div class="side-controls" id="controls"></div>

<div id="radar-modal">
  <div style="font-weight:bold; color:var(--tesla-red);">‚ö†Ô∏è RADAR ‚ö†Ô∏è</div>
  <div style="font-size:24px; margin:10px 0;" id="modal-speed">--</div>
  <div id="dist-text">APPROCHE...</div>
  <div id="proxi-bar"></div>
</div>

<div id="clock"></div>

<script>
/* CONFIG */
let config = { distance:500, volume:0.15, soundEnabled:true };
let followDirection = true;
let userPos = null, carMarker = null, radarLayer = null;
let bearing = 0, explorationMode = true;

/* INIT MAP */
var map = L.map('map',{zoomControl:false,maxZoom:18});
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
radarLayer = L.layerGroup().addTo(map);

/* CAR ICON */
const carSvg = `<svg width="50" height="50" viewBox="0 0 100 100"><path d="M50 10 L85 85 L50 70 L15 85 Z" fill="#E81922" stroke="white" stroke-width="5" stroke-linejoin="round"/></svg>`;

/* AUDIO ALERT */
let audioCtx=null;
function initAudio(){
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  alert("Audio activ√©");
}
function beep(){
  if(!audioCtx || !config.soundEnabled) return;
  let osc=audioCtx.createOscillator(), g=audioCtx.createGain();
  osc.connect(g); g.connect(audioCtx.destination);
  osc.frequency.value=880;
  g.gain.setValueAtTime(config.volume,audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.15);
  osc.start(); osc.stop(audioCtx.currentTime+0.15);
}

/* SPEECH */
function speakAlert(dist){
  if('speechSynthesis' in window){
    const msg = new SpeechSynthesisUtterance("Radar dans " + Math.round(dist) + " m√®tres");
    msg.lang="fr-FR";
    window.speechSynthesis.speak(msg);
  }
}

/* RADAR MODAL */
function triggerModal(speed,dist){
  const modal = document.getElementById('radar-modal');
  document.getElementById('modal-speed').innerText = speed;
  document.getElementById('dist-text').innerText = Math.round(dist) + "m - RALENTIR";
  if(!modal.classList.contains('show')){
    beep(); speakAlert(dist);
    modal.classList.add('show');
    setTimeout(()=>modal.classList.remove('show'),3000);
  }
}

/* POSITION CAR */
function moveCar(latlng){
  if(userPos) bearing = L.GeometryUtil.getBearing(userPos,latlng);
  userPos = latlng;

  if(!carMarker){
    carMarker = L.marker(userPos,{icon:L.divIcon({html:`<div>${carSvg}</div>`,className:'',iconSize:[50,50],iconAnchor:[25,25]})}).addTo(map);
  }else{ carMarker.setLatLng(userPos); }

  if(explorationMode && followDirection) map.setView(userPos,map.getZoom(),{animate:true});
}

/* FAKE RADARS FOR TEST (SIMULATION) */
const radars = [
  {lat:48.8566,lng:2.3522,speed:50},
  {lat:48.8570,lng:2.3550,speed:90},
  {lat:48.8585,lng:2.3600,speed:70}
];

function checkRadars(){
  radarLayer.clearLayers();
  radars.forEach(r=>{
    const radarPos = L.latLng(r.lat,r.lng);
    L.marker(radarPos,{icon:L.divIcon({html:`<div style="background:rgba(255,0,0,0.2);width:30px;height:30px;border-radius:50%;"></div>`,className:'',iconSize:[30,30],iconAnchor:[15,15]})}).addTo(radarLayer);
    const dist = map.distance(userPos,radarPos);
    let diff = Math.abs(bearing-L.GeometryUtil.getBearing(userPos,radarPos));
    if(diff>180) diff = 360-diff;
    if(dist<config.distance && diff<30) triggerModal(r.speed,dist);
  });
}

/* SIMULATION TRAJECTORY */
let idx=0;
const path=[{lat:48.8565,lng:2.352},{lat:48.857,lng:2.353},{lat:48.8575,lng:2.354},{lat:48.858,lng:2.355},{lat:48.8585,lng:2.356}];
function simulate(){
  if(idx>=path.length) idx=0;
  moveCar(L.latLng(path[idx].lat,path[idx].lng));
  checkRadars();
  idx++;
  setTimeout(simulate,1000);
}

/* BOUTONS */
const controls = document.getElementById('controls');

const btnAudio = document.createElement('button');
btnAudio.className='side-btn'; btnAudio.innerText='üîä';
btnAudio.onclick=()=>initAudio();
controls.appendChild(btnAudio);

const btnNorth = document.createElement('button');
btnNorth.className='side-btn'; btnNorth.innerText='üß≠';
btnNorth.onclick=()=>{ followDirection=!followDirection; alert("Orientation " + (followDirection?"SENS":"NORD")); };
controls.appendChild(btnNorth);

const btnRecenter = document.createElement('button');
btnRecenter.className='side-btn'; btnRecenter.innerText='üìç';
btnRecenter.onclick=()=>{ if(userPos) map.setView(userPos,map.getZoom(),{animate:true}); };
controls.appendChild(btnRecenter);

/* CLOCK */
setInterval(()=>document.getElementById('clock').innerText=new Date().toLocaleTimeString('fr-FR'),1000);

/* START SIMULATION */
simulate();

/* SERVICE WORKER FOR CACHE */
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('./sw.js').then(()=>console.log("SW OK"));
}
</script>
</body>
</html>
