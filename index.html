<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<title>TeslaPilot V1 - Navigation & Radar</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-geometryutil@0.9.3/src/leaflet.geometryutil.min.js"></script>

<style>
:root { --tesla-red:#E81922; --glass:rgba(0,0,0,0.95); }
html,body{margin:0;height:100%;background:#000;color:#fff;font-family:Segoe UI;overflow:hidden;}

#map-container{width:100%;height:100%;position:relative;}
#map{position:absolute;top:-50%;left:-50%;width:200%;height:200%;transition:transform .6s cubic-bezier(.4,0,.2,1);}

.side-controls{position:absolute;top:20px;right:20px;z-index:2000;display:flex;flex-direction:column;gap:12px;}
.side-btn{width:55px;height:55px;border-radius:50%;background:var(--glass);border:1px solid rgba(255,255,255,.2);color:#fff;font-weight:bold;cursor:pointer}

#radar-modal{
    position:absolute;top:40%;left:50%;
    transform:translate(-50%,-50%) scale(.5);
    width:300px;
    background:var(--glass);
    border:5px solid var(--tesla-red);
    border-radius:35px;
    padding:25px;
    text-align:center;
    opacity:0;visibility:hidden;
    transition:.4s cubic-bezier(.175,.885,.32,1.275);
    z-index:9999;
}
#radar-modal.show{transform:translate(-50%,-50%) scale(1.4);opacity:1;visibility:visible;}

.speed-circle{
    width:90px;height:90px;border:8px solid var(--tesla-red);
    border-radius:50%;display:flex;align-items:center;justify-content:center;
    font-size:40px;font-weight:900;background:#fff;color:#000;margin:15px auto;
}

/* BARRE CORRIGÉE (VERT → ROUGE) */
.proxi-container{width:100%;height:12px;background:#333;border-radius:10px;overflow:hidden}
#proxi-bar{
    width:0%;
    height:100%;
    background:linear-gradient(90deg,#00ff00,#ffea00,#ff0000);
    transition:width .3s ease-out;
}

.status-panel{
    position:absolute;bottom:20px;right:20px;
    padding:12px 20px;border-radius:15px;
    background:rgba(0,0,0,.7);
    backdrop-filter:blur(10px);
    border-right:4px solid var(--tesla-red);
}
</style>
</head>

<body>

<div id="radar-modal">
    <div style="color:var(--tesla-red);font-weight:900">⚠️ RADAR ⚠️</div>
    <div class="speed-circle" id="modal-speed">--</div>
    <div id="dist-text">APPROCHE...</div>
    <div class="proxi-container"><div id="proxi-bar"></div></div>
</div>

<div class="side-controls">
    <button class="side-btn" onclick="toggleOrientation()">NORD</button>
    <button class="side-btn" onclick="map.zoomIn()">+</button>
    <button class="side-btn" onclick="map.zoomOut()">-</button>
</div>

<div class="status-panel">
    <div id="clock">00:00:00</div>
</div>

<div id="map-container"><div id="map"></div></div>

<script>
let config={distance:500,volume:.15,soundEnabled:true};
let mapMode="north",myPos=null,lastQueryPos=null,currentBearing=0;
let audioCtx=null,lastAlertTime=0;

const overpassServers=[
 "https://overpass-api.de/api/interpreter",
 "https://overpass.kumi.systems/api/interpreter",
 "https://overpass.nchc.org.tw/api/interpreter"
];

function initAudio(){
 audioCtx=new(window.AudioContext||window.webkitAudioContext)();
}

function beep(){
 if(!audioCtx||!config.soundEnabled)return;
 const o=audioCtx.createOscillator(),g=audioCtx.createGain();
 o.connect(g);g.connect(audioCtx.destination);
 o.frequency.value=880;
 g.gain.value=config.volume;
 g.gain.exponentialRampToValueAtTime(.01,audioCtx.currentTime+.15);
 o.start();o.stop(audioCtx.currentTime+.15);
}

function toggleOrientation(){
 mapMode=mapMode==="north"?"direction":"north";
 updateRotation();
}

function updateRotation(){
 document.getElementById("map").style.transform=
  mapMode==="direction"?`rotate(${-currentBearing}deg)`:"rotate(0)";
}

function updateProgressBar(dist){
 const pct=Math.max(0,Math.min(100,(dist/config.distance)*100));
 document.getElementById("proxi-bar").style.width=(100-pct)+"%";
 document.getElementById("dist-text").innerText=Math.round(dist)+" m";
}

function moveCar(latlng){
 if(myPos&&map.distance(myPos,latlng)>5){
  currentBearing=L.GeometryUtil.getBearing(myPos,latlng);
 }
 myPos=latlng;
 map.panTo(myPos,{animate:true});
 updateRotation();

 if(!lastQueryPos||map.distance(myPos,lastQueryPos)>1000){
  fetchRadars();
  lastQueryPos=myPos;
 }
}

function isFacingRadar(userBearing,userPos,radarPos){
 let b=L.GeometryUtil.getBearing(userPos,radarPos);
 let d=Math.abs(userBearing-b);
 if(d>180)d=360-d;
 return d<45;
}

async function fetchRadars(){
 if(!myPos)return;
 const b=map.getBounds().pad(.5);
 const query=`[out:json];
 node["highway"="speed_camera"](${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()});
 out body;`;

 try{
  const res=await fetch(overpassServers[0]+"?data="+encodeURIComponent(query));
  const data=await res.json();
  radarLayer.clearLayers();

  let alertActive=false;
  let lastRadarDist=Infinity;

  data.elements.forEach(r=>{
   const p=L.latLng(r.lat,r.lon);
   const dist=map.distance(myPos,p);

   if(
    dist<config.distance &&
    dist<lastRadarDist &&
    isFacingRadar(currentBearing,myPos,p)
   ){
    updateProgressBar(dist);
    triggerModal(r.tags?.maxspeed||"??");
    lastRadarDist=dist;
    alertActive=true;
   }
  });

  if(!alertActive){
   document.getElementById("radar-modal").classList.remove("show");
  }
 }catch(e){console.error(e);}
}

function triggerModal(speed){
 const modal=document.getElementById("radar-modal");
 const now=Date.now();

 if(!modal.classList.contains("show")){
  modal.classList.add("show");
  document.getElementById("modal-speed").innerText=speed;
  beep();
  lastAlertTime=now;
  return;
 }

 if(now-lastAlertTime>3000){
  beep();
  lastAlertTime=now;
 }
}

const map=L.map("map",{zoomControl:false,maxZoom:18});
L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}").addTo(map);
const radarLayer=L.layerGroup().addTo(map);

map.on("locationfound",e=>moveCar(e.latlng));
map.locate({setView:true,watch:true,enableHighAccuracy:true});

setInterval(()=>clock.innerText=new Date().toLocaleTimeString("fr-FR"),1000);
</script>

</body>
</html>
